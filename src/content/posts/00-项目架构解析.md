# 00-项目架构解析

## 1. 仓库结构与职责

- `Vue/`：前端应用（Vue 3 + Vite + Pinia + Tailwind）。
- `server/`：后端服务（Express v5 + Mongoose，ESM：`type: module`）。
- `scripts/`：更新脚本（生产 `update.sh`，本地测试 `test-update.ps1` / `test-update.sh`）。
- `uploads/`：后端静态暴露目录（运行时生成/依赖，代码里通过 `/uploads` 暴露）。
- `dist/`：当它存在于**项目根目录**时，后端会把它作为前端静态资源托管（见 `server/server.js`）。

## 2. 端到端数据流（开发环境）

1. 浏览器访问前端（`Vue/` 的 Vite Dev Server）。
2. 前端调用 API：统一走 `Vue/src/api/request.js`。
3. Vite 代理：`Vue/vite.config.ts` 把 `/api/*` 代理到 `VITE_API_BASE_URL`，并 rewrite 去掉 `/api`。
4. Express 路由处理：`server/server.js` 按前缀挂载各 router。
5. 后端访问资源：
   - MongoDB：通过 `server/db/db.js` 建立 Mongoose 连接；模型在 `server/db/*.js`。
   - SFTP（图片上传/删除）：`server/expressRoutes/imageExpress.js` 通过 `ssh2-sftp-client` 连接远程服务器，并用 `sharp` 压缩/转码。

## 3. 核心入口与挂载关系

### 3.1 后端入口

- 入口：`server/server.js`
- 关键点：
  - ESM 写法（`import/export`），不要用 CommonJS `require`。
  - 内置日志：`server/utils/logger.js`（请求日志 + console 重定向 + 异常落盘）。
  - CORS：默认不开启；仅当 `ENABLE_CORS=true` 时启用。
  - 静态目录：`/uploads` → `../uploads`。
  - 若根目录存在 `dist/`，会托管前端静态并对 SPA 做 `*` 回退到 `index.html`。

### 3.2 后端路由前缀

在 `server/server.js`：

- `/home` → `server/expressRoutes/userExpress.js`
- `/login` → `server/expressRoutes/loginExpress.js`
- `/file` → `server/expressRoutes/imageExpress.js`
- `/update` → `server/expressRoutes/updateExpress.js`
- `/news` → `server/expressRoutes/newsExpress.js`

注意：router 文件内部声明的路径会再叠加前缀。例如 `userExpress.js` 里写的是 `/userInfo/getAllUserInfo`，最终对外路径是：`/home/userInfo/getAllUserInfo`。

### 3.3 前端入口

- HTML 入口：`Vue/index.html`（加载 `/src/main.ts`）
- 应用入口：`Vue/src/main.ts`
  - `createPinia()` 注册 Pinia
  - `router` 来自 `Vue/src/router/router.js`

## 4. 前端约定（组件 / 路由 / API）

- 路由：`Vue/src/router/router.js`
  - Layout 容器：`Vue/src/layout/layout.vue`
  - 主页面都在 Layout 的 children 下（`/home`、`/news` 等）
  - 登录页：`/login`
- API 封装：`Vue/src/api/request.js`
  - `baseURL: 'api'`，配合 Vite 代理。
  - 自动注入 `Authorization: Bearer <token>`（token 来源：`Vue/src/stores/loginStore.js`）。
  - 错误统一交给 `Vue/src/stores/common.js` 弹窗。

## 5. 鉴权现状与注意事项

- 后端提供了 `authMiddleware`（`server/expressRoutes/loginExpress.js` 导出），会校验 `Authorization: Bearer <token>`。
- 当前 `userExpress.js` 虽然 import 了 `authMiddleware`，但未实际在路由上使用（即：用户信息相关接口目前**默认不鉴权**）。
- 前端会在请求拦截器里自动带 token；如果你在后端把接口加上鉴权，前端不需要额外改动（前提是走 `request.js` 封装）。

## 6. 本地开发最短路径（Windows 友好）

### 后端

在 `server/`：

- 安装：`pnpm install`
- 启动（开发）：`pnpm run node`（等价：`cross-env NODE_ENV=development node ./server.js`）

默认：`http://0.0.0.0:3008`

### 前端

在 `Vue/`：

- 安装：`pnpm install`
- 启动：`pnpm run dev`

建议新建 `Vue/.env.development`（不要提交敏感信息）：

- `VITE_API_BASE_URL=http://localhost:3008`

## 7. 常见“改动点”导航

- 想新增后端接口：看 `server/expressRoutes/*.js`（并在 `server/server.js` 挂载）。
- 想新增/修改数据库结构：看 `server/db/*.js`。
- 想新增前端页面：放到 `Vue/src/views/` 并在 `Vue/src/router/router.js` 注册路由。
- 想新增前端接口封装：放到 `Vue/src/api/`，统一使用 `request.js`。
